<html>
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<!-- <link  href="cropperjs-master/src/css/cropper.css" rel="stylesheet"> -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.7/cropper.css" integrity="sha512-AuLN6bHjJzqZ+Iw48+GdQPp5uKBdPX6+zWV37ju9zw7XIrevIX01RsLtpTU/zCoQcKrQRPe/EpwDpZiv7OUYMA==" crossorigin="anonymous" />
	<!-- <script src="cropperjs-master/src/js/cropper.js" type="module"></script> -->
	<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.7/cropper.js"></script> -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.7/cropper.js" integrity="sha512-giNJUOlLO0dY67uM6egCyoEHV/pBZ048SNOoPH4d6zJNnPcrRkZcxpo3gsNnsy+MI8hjKk/NRAOTFVE/u0HtCQ==" crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
	<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
	<style type="text/css">
		/* Ensure the size of the image fit the container perfectly */
		img {
		  display: block;

		  /* This rule is very important, please don't ignore this */
		  max-width: 100%;
		}
 
	  .puzzle-piece{
			
	  } 

  	  #puzzle_container{
			display: flex; 
			flex-wrap: wrap;

		}  
	</style>
</head>
<body>
	<div style="visibility: hidden; position: absolute;">
	  <img src="emma.jpg" crossorigin="anonymous" id="target"> 
	</div>
	<div>
	</div>
	<div class="container">
		<h1 class="text-center">jigsaw game</h1>
		<div class="mx-auto" id="puzzle_container"></div>
	</div>
	<div id="puzzle_piece_template" class="puzzle-piece">
		
	</div>
</body>
	<script type="text/javascript">
		let newImage;
    let substitute;

		const cropper = new Cropper(target, {
		  // aspectRatio: 16 / 9, // this affects the cropping parameters, don't enable it
		  crop(event) {

		  },
		  ready() {
		    let imageData = this.cropper.getImageData();

		    // set puzzle container to the aspect ratio of the image
/*		    let aspectRatioInverse = imageData.height / imageData.width;
		    aspectRatioInverse = Math.round(aspectRatioInverse * 100) / 100;
		    puzzle_container.style.width = "100%";
		    puzzle_container.style.paddingBottom = aspectRatioInverse * 100 + "%";*/
		    puzzle_container.style.width = "50vw";
		    puzzle_container.style.height = puzzle_container.offsetWidth / imageData.aspectRatio + "px";
		    let counter = 0;
     		for(let j = 1; j <= 2; j++){
			     for(let i = 1; i <= 3; i++){
							// set  crop size 
							this.cropper.setData({x: (i-1) * imageData.naturalWidth / 3, y:(j-1) * imageData.naturalHeight / 2, width: (imageData.naturalWidth / 3), height: (imageData.naturalHeight / 2) })

							// crop image
							let newImageCanvas = this.cropper.getCroppedCanvas({height: puzzle_container.offsetHeight / 2});
							// constraint piece size

							// show new image
							let puzzle_piece = puzzle_piece_template.cloneNode();
							puzzle_container.appendChild(puzzle_piece)
							puzzle_piece.id = '';
							puzzle_piece.appendChild(newImageCanvas);

							console.log(puzzle_piece);

							// assign the correct position to each piece
							puzzle_piece.correctPosition = counter;

							// add dragging ability
							makeDraggable(puzzle_piece);




							this.cropper.reset();
			     		counter++;


		     		}
		    }
			  // shuffle puzzle
				$(function () {
					var parent = $(puzzle_container);
					var divs = parent.children();
					while (divs.length) {
						parent.append(divs.splice(Math.floor(Math.random() * divs.length), 1)[0]);
					}
				});

				 // save image in filesystem
				 /*newImage.crossOrigin="anonymous";

				 var image = newImage.toDataURL("image/png").replace("image/png", "image/octet-stream");  // here is the most important part because if you dont replace you will get a DOM 18 exception.


				 window.location.href=image; // it will save locally*/

		   },
		});

		let makeDraggable = function (puzzle_piece){

			$(puzzle_piece).draggable({ 
				containment: "parent", 
				revert: "invalid",
				revertDuration: 120,
			  classes: {
			    "ui-draggable": "highlight"
			  },
			  opacity: 0.65,
				stack: ".puzzle-piece",
				start: function() {
					// $( this ).addClass("border border-primary");
				},
				drag: function() {
				},
				stop: function() {
				},
				create: function( event, ui ) {

				}
			});
			$(puzzle_piece).draggable("enable");
			$(puzzle_piece).droppable({
				classes: {
			    "ui-droppable-hover": "highlight"
			  },
				greedy: true,
				drop: function( event, ui ) {

					let draggedPiecePrev = ui.draggable.prev();
					ui.draggable.insertBefore($(this));
					if(draggedPiecePrev.length == 0){
						$(this).prependTo($(this).parent());
					}
					else{
						$(this).insertAfter(draggedPiecePrev);
					}
					ui.draggable.css("top", 0);
					ui.draggable.css("left", 0);


				}
			});
		}


	</script>
</html>